machine:
  environment:
    GOLANG_VERSION: 1.4rc1
    CIRCLECI_DRIVES_ME_CRAZY: "mode: count"

  # services:
  #   - cassandra
  #   - elasticsearch
  #   - rabbitmq-server
  #   - riak
  #   - beanstalkd
  #   - couchbase-server
  #   - neo4j
  #   - sphinxsearch

  hosts:
    fancy: 127.0.0.1

dependencies:
  pre:
    - curl -k -L -o go.tar.gz https://golang.org/dl/go$GOLANG_VERSION.linux-amd64.tar.gz
    - sudo rm -rf /usr/local/go
    - sudo tar -C /usr/local -xzf go.tar.gz
    - sudo chmod a+w /usr/local/go/src/
  post:
    - go get github.com/axw/gocov/gocov
    - go get github.com/mattn/goveralls
    - go get github.com/golang/lint/golint

test:
  pre:
    - go version

  override:
    - echo $CIRCLECI_DRIVES_ME_CRAZY > profile.cov
    # Go fmt
    - test -z "$(gofmt -s -l -w .     | tee /dev/stderr)"
    # Go lint
    - test -z "$(golint ./...          | tee /dev/stderr)"
    # Go vet
    - go vet ./...
    # Actual tests
    - find ./ -not -path '*.git*' -not -path '*/_*' -type d -exec go test -v -race -covermode=count -coverprofile={}/profile.tmp {} \;
    - find ./ -iname "profile.tmp" -exec tail -n +2 {} >> profile.cov \;
    - goveralls -service drone.io -coverprofile=profile.cov -repotoken $COVERALLS_TOKEN

  # post:
  #   - find ./ -iname "profile.tmp" -exec tail -n +2 {} >> profile.cov \;
  #   - goveralls -service drone.io -coverprofile=profile.cov -repotoken $COVERALLS_TOKEN

general:
  branches:
    ignore:
      - master
      - 0.7
      - 0.8
      - 0.9
      - 1.0

# notify:
#     email:
#         recipients:
#             - distribution@docker.com

#     slack:
#         team: docker
#         channel: "#dt"
#         username: mom
#         token: {{SLACK_TOKEN}}
#         on_success: false
#         on_failure: true

  #Â Do we want these as well?
  # - go get code.google.com/p/go.tools/cmd/goimports
  # - test -z "$(goimports -l -w ./... | tee /dev/stderr)"
  # http://labix.org/gocheck
